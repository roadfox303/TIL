### Postgres バージョンのメジャーアップデートによる不具合
##### [2020/7/30]
##### 症状
- brewアップデートに伴い、なぜか勝手に postgres のバージョンまでアップデート(ver11→ver12)されたと思われる。
- postgres の データディレクトリが旧バージョンで作成されているため、新バージョンからでは参照できなくなった。
  - bash: /usr/local/bin/psql: No such file or directory

##### 対処
- 本来は、DBのデータを退避し、新バージョンのデータベースクラスタ（データディレクトリ含む）を作成した後に移植するだけでよかったと思う。
- 今回は初めてだったため、バージョン11に戻そうとか、いろいろ試す過程でDBが消えてしまった。多分下記のコマンドを実行したのだと思う。
```
rm /usr/local/var/postgres/postmaster.pid
```

- どうせDBが全て消えてしまったので、バージョン12で一から環境を整えることにした。

##### 具体的解決
1. brew でポスグレの最新版インストール
```
brew install postgresql
```

2. **psql** コマンドエイリアスの登録（登録しないと psql コマンドが使えない。※旧バージョンで登録されているから）
```
alias psql='/usr/local/opt/postgresql/bin/psql'
```

3. 予めディレクトリを作成（データベースクラスタ用）
```
mkdir /usr/local/pgsql/data
# 本来であればこのディレクトリの所有ユーザーを chown で postgres　にしなければならないが、brew でインストールされている場合は必要ない。
```

4. スーパーユーザーでコマンド実行(以降のコマンドがスーパーユーザー権限になる)
```
su ユーザー名
```

5. データベースクラスタのイニシャライズ
```
initdb -D /usr/local/pgsql/data
```

6. サーバの初期化、起動
```
pg_ctl -D /usr/local/pgsql/data -l logfile start
```

##### 所感
- 焦らずに対処すれば、DBを守れたと思う。
- ただしDBが無事の場合は、退避や移植の作業が必要なので、もし次にバージョン変更の機会がある場合はその辺を調べるべき。
---
