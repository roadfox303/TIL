# [Udemy]ゼロから実践するAmazon Web Services。手を動かしながらインフラの基礎を習得
---
### インフラ構築の手順
1. サーバー構成
  - どのようなサーバーが必要か考える
  - サーバーを設置する
  - サーバーのOSをインストールして各種設定
  - 必要なソフトウェアをインストール
2. ネットワークの構成
  - 構築したサーバーをネットワークに接続する
    - ネットワークで使用するIPアドレスの範囲を決める
    - サーバーにIPアドレスを割り当てる
    - ドメイン名とIPアドレスの対応を割り当てる

---
### 【VPC】ネットワークを構築
#### AWSネットワークの概念
- リージョン
  - リージョンによって、使えるサービスが違う。
  - リージョンには複数のアベイラビリティゾーンがある。
- アベイラビリティゾーン
  - 独立したデータセンター
  - 物理的に距離が離れており、災害時などにも他の(データセンターの)サーバーが使える。
  - リージョンの、ap-northeast-1a、ap-northeast-1c、などの末尾の表記(1aや1c)がアベイラビリティゾーン。

#### VPC (Virtuial Private Cloud)
- AWS上に仮想ネットワークを作成できるサービス。
- サブネット
  - VPCを細かく区切ったネットワーク。
  - AWSでサーバーを設置する際は、サブネットに配置する事になる。
  - サブネットはアベイラビリティゾーンの中に作る。サブネットをそれぞれ別のアベイラビリティゾーンに配置することもできる。

#### IPアドレス
- ネットワーク上で重複しない番号
- 32ビットの２進数で構成される。
- 長くて読みにくいので、8ビットづつ4つの組に分けて、ピリオドを入れて10進数で表現する。
  - 0.0.0.0 ~ 255.255.255.255

- パブリックIPアドレス
  - インターネット接続する際に使用する。
  - プロバイダーやサーバー事業者から貸し出される。(AWS上でも貸し出される)
- プライベートIPアドレス
  - インターネットでは使用されないIPアドレス。
  - 下記の範囲内のアドレスを自由に使用することができる。
  - 10.0.0.0 ~ 10.255.255.255
  - 172.16.0.0 ~ 172.31.255.255
  - 192.168.0.0 ~ 192.168.255.255
  - 社内LANやネットワーク実験などはプライベートIPアドレスを使用する。

- ネットワークを構築する際はそのネットワークで使用するIPアドレスの範囲を決める。
  - ネットワーク部とホスト部に区分けする事で範囲を表記する。
  - 192.168.128.0 ~ 192.168.128.255 まで256個のIPアドレスを使用するとしたら、
  - 192.168.128 までがの固定部分がネットワーク部、末尾の 0 ~ 255 の可変部分がホスト部。
  - CIDR表記: 192.168.128.0/24 (ネットワーク部が先頭から何ビットまでかを/の後に記載する)
  - サブネッマスク表記: 192.168.128.0/255.255.255.0 (IPアドレス末尾に/をつけ、ネットワーク部に相当するビットを1で、ホスト部に相当するビットを0で表す。)

#### AWSでVPCネットワークを構築する。
###### 1. VPCを作成する
**VPC設計のポイント**
- プライベートIPアドレス範囲からし指定する。
- 作成後は範囲を変更できないので、大きめに設定する。
  - /28 から /16。/16 が推奨。
- オンプレミス(自社運用サーバ)や他VPCのレンジと重複しないように気を付ける。
  - オンプレミスの運用がない場合は気にしなくても良い。
  - 相互接続する可能性がある場合は重複しないように設計。

**VPCを分割するか？アカウントを分割するか？**
- 異なるシステムの場合はアカウントを分ける。
  - 異なるシステムを同一アカウント内に入れると管理が煩雑になる。
- 同一システムの各環境(product,develop,test)は、VPCとアカウントのどちらを分けるか?
  - 環境が違う場合、アカウントもVPCも同じというのはダメ。(アカウントは同じでVPCを分けるなどが良い)
  - VPCでわける場合、IAMの設定が一度で良い。反面、各環境のリソースが見えてしまい、事故の元にもなりえる。
  - アカウントを分けると、他の環境のソースが見えないので、作業しやすい。反面、環境毎にIAMの設定が必要。
  - 同一アカウントで、VPCとリージョンで分けるのがオススメ。


###### 2. サブネットを作成する
- パブリックサブネット
- プライベートサブネット

**サブネット設計のポイント**
- 将来に必要なIPアドレス数を見積もって設定する。
  - /24が標準的
- サブネットの分割はルーティングとアベイラビリティゾーンを基準に行う。
  - サブネットに割り当てられるルートテーブルは１つ。
  - インターネットアクセスの有無、拠点アクセスの有無など、ルーティングポリシーに応じて分割する。(インターネットに接続するパブリックと、しないプライベートに分割するなど)
  - 冗長性のために２つ以上のアベイラビリティゾーンを使用する際など。

###### 3. ルーティングを設定する
- インターネットゲートウェイを作成し、VPCにアタッチする。
- ルートテーブルを作成しパブリックサブネットに紐付ける。
  - ルートテーブルのイメージ。
  |宛先IPアドレス|ルーター（ターゲット）|
  |:---:|:---:|
  |10.0.1.0/24|local|
  |10.0.2.0/24|ルーターB|
  |0.0.0.0/0|ルーターC|

  - パブリックサブネットの 0.0.0.0/16 のターゲットをインターネットゲートウェイに設定する事でインターネットと接続できる。
  - ルートテーブルは各サブネットに対して設定できる。
  - サブネットやインターネットゲートウェイ間には暗黙的にルーターが動いている。

---
### 【EC2】Wecサーバーを構築する
- EC2 : Elastic Compute Cloud。AWSクラウド上の仮想サーバー。
- AMI : Amazon Machine Image。インスタンス起動に必要な情報が入ったOSのイメージ。サーバーのテンプレートのようなもの。
  - AWSやサードパティがAMIを提供。
  - 自前のカスタムAMIも作成可能。
- インスタンスタイプ
  - サーバーのスペックを定義したもの。
  - CPU、メモリ、ストレージ、ネットワーク帯域など。
  - スペックが高いほど料金も高い
  - インスタンスタイプ：m5.xlarge：m(インスタンスファミリー)5(インスタンス 世代).xlarge(インスタンスサイズ)
- EC2のストレージには2種類ある
  - **EBS (Elastic Block Strage)**
  - 高い可用性と耐久性を持つ
  - 他のインスタンスに付け替え可能
  - EC2インスタンスを停止や削除しても EBS は保持可能
  - OS や DB などの永続性と耐久性が必要なデータを置く
  - Snapshotを取得してS3に保存可能
  - EBSの費用が別途発生
  - **インスタンスストア**
  - インスタンスの一時的なストレージ
  - インスタンスに基づいているので、他のインスタンスに付け替えることはできない
  - EC2インスタンスを停止、削除するとクリアされる
  - 追加費用はかからない。
  - なくなってはいけないデータは置かない
  - キャッシュや一時ファイルだけを置く

#### SSH について
- サーバー(SSHサーバー)とPC(SSHクライアント)をセキュアに繋ぐサービスのこと
- 通信内容が暗号化された遠隔ログインシステム
- EC2にログインするときはSSHを使用する。
- サーバー上でSSH接続を受入れ、SSHDというプログラムが動いて接続される。

```
# 初回のみ下記のコマンドで秘密鍵の権限を厳格化しておく。しないと AWS EC2 にはログインできない。
$ chmod 600 ファイルパス

# EC2にログイン
$ ssh -i SSHキー.pem ec2-user@インスタンスのパブリックIP

# ポートを確認するコマンド
$ sudo lsof -i -n -P
```

#### Apache (webサーバ)の準備
```
# AWS EC2 サーバ上で
$ sudo yum -y install httpd
# httpd はアパッチ

# アパッチの起動
$ sudo systemctl start httpd.service

# アパッチの状態確認
$ sudo systemctl status httpd.service

# アパッチ(Webサーバー)の自動起動（サーバーの起動時にアパッチも自動で起動）
$ sudo systemctl enable httpd.service

# 自動起動設定ができているか確認
$ sudo systemctl is-enabled httpd.service
> enabled #自動起動設定が成功している

```

#### ファイアウォールを設定
- ファイアウォールを設定しないとWebページを表示することができない。
- 必要な通信以外を通さない機能

- AWSではセキュリティグループがファイアウォールの役割を担っている。
  - **インバウンド** サーバーへ入ってくる通信。必要なポートだけを開ける
  - **アウトバウンド** サーバーから出ていく通信。多くの場合全て開いている。

- AWSコンソールマネジメントで、インスタンスのセキュリティグループから編集。
  - ※udemy 動画から レクチャー29　を参照。

#### Elastic IP で パブリックIPアドレスを固定

### Route53
#### ドメインの構造
**www.example.co.jp**

|第４レベルドメイン|第3レベルドメイン|第2レベルドメイン|トップレベルドメイン|
|:---:|:---:|:---:|:---:|
|www|example|co|jp|

- 各レベルのドメインは一意であるように管理されている。
  - **ICANN** … ドメイン全体を管理
  - **レジストリ** … トップレベルドメインを管理。レジストラに卸す。1つのトップレベルドメインは、一つのレジストリ組織が管理している。ドメインの販売は行っていない。
  - **レジストラ** … リセラに卸す。一般消費者に販売。
  - **リセラ** … 一般販売者に販売。

#### DNS
- DNS
  - ドメインとIPアドレスを変換する。
  - ネームサーバーとフルリゾルバの２つから構成される。
- ネームサーバー
  - ドメインと、それに紐づくIPアドレスが登録されている。
- フルリゾルバ
  - ドメインに基づくIPアドレスを問い合わせると、色々なネームサーバーに聞いてIPアドレスを調べて答えてくれるサーバー

##### Route53
**特徴**
- AWSのDNSサービス（ネームサーバー）
- 高速、高可用性

**重要概念**
- ホストゾーン
  - DNSリソースレコードの集合体。
- レコードセット
  - リソースレコードのこと
- ルーティングポリシー
  - Route53 が Record Set に対してどのようにルーティングを行うか決める
- ヘルスチェック
  - サーバの稼働状態をチェック
