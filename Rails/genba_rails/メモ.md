# 現場で使える Ruby on Rails5 速習実践ガイド

### Railsの基本原則
##### Optimize for programmer happiness
- 開発者の幸せのために最適化する

##### Convention over Configuration
- 設定よりも規約を重視する

##### The menu in omakase
- Railsにおまかせする

##### No one paradigm
- 複数のパラダイムを適用する

##### Exalt beautiful code
- 美しいコードを称える

##### Provide sharp knives
- 切れるナイフを提供する

##### Value integrated system
- 統合システムを尊重する

##### Progress over stability
- 安定よりも進歩を重視する

##### Push up big tent
- 大きなテントを張る

## Chapter1 RailsのためのRuby入門

##### nil ガード
- もし number があれば(trueなら) number、無ければ(false か nil なら) number に 10 を代入した上で number
```
number ||= 10
```

##### ぼっち演算子 &.
- レシーバが nil でもエラーが発生しなくなる。
```
# ifを使った記述
name = if object
  object.name
else
  nil
end
```
```
# &.を使った記述
name = object&.name
```

##### map と &:
```
# 普通にブロックで処理する場合
names = users.map do |user|
  user.name
end
```
```
# &: で処理する場合
names = users.map(&:name)
```

## Chapter2 Railsアプリケーションをのぞいてみよう
- link_to は ヘルパーメソッド(ビューで利用できる便利な機能)

### Railsアプリのディレクトリ構成
##### 全体構成
```
Scaffold_app                  # << アプリ >>
  ┣━━ app                     # << 主要なプログラム >>
  ┃    ┣━━ assets             # << アセットに関するファイル >>
  ┃    ┃     ┣━━ config       # アセットパイプライン用設定ファイル
  ┃    ┃     ┣━━ images       # 画像ファイル
  ┃    ┃     ┣━━ javascript   # JavaScriptファイル
  ┃    ┃     ┗━━ stylesheets  # スタイルシート
  ┃    ┣━━ channels           # ActionCable ファイル
  ┃    ┣━━ controllers        # コントローラファイル
  ┃    ┃     ┗━━ concerns     # 複数のコントローラで使う共通処理
  ┃    ┣━━ helpers            # 主にビューでの共通処理を定義するヘルパーファイル
  ┃    ┣━━ jobs               # バックグラウンドでジョブを実行する際に使用
  ┃    ┣━━ mailers            # ActionMailer用ファイル
  ┃    ┣━━ models             # モデルファイル
  ┃    ┃     ┗━━ concerns     # 複数のモデルで使う共通処理
  ┃    ┗━━ views              # ビューテンプレートファイル
  ┃          ┗━━ layouts      # レイアウトファイル
  ┣━━ bin                     # スクリプトファイル
  ┣━━ config                  # 設定ファイル
  ┃    ┣━━ enviroments        # 実行環境ごとの設定ファイル
  ┃    ┣━━ initializers       # 初期化用ファイル
  ┃    ┗━━ locales            # 多言語対応のための辞書ファイル
  ┣━━ db                      # DBに関するファイル
  ┃    ┗━━ migrate            # マイグレートファイル
  ┣━━ lib                     # 自作ライブラリ
  ┃    ┣━━ assets             # 自作ライブラリに関するアセットファイル
  ┃    ┗━━ tasks              # 自作の Rake タスク
  ┣━━ log                     # ログファイル
  ┣━━ public                  # 静的ファイル
  ┣━━ storage                 # ActiveStrage 用ファイル
  ┣━━ test                    # テスト用ファイル
  ┣━━ tmp                     # 一時ファイル（テンポラリーファイル）
  ┗━━ vendor                  # 外部ライブラリ用ディレクトリ
```

##### config構成
```
config                        # << コンフィグ >>
  ┣━━ application.rb          # アプリケーション共通の設定
  ┣━━ boot.rb                 # 起動に関する設定
  ┣━━ cable.yml               # ActionCable用の設定
  ┣━━ credentials.yml.enc     # 暗号化情報などの設定
  ┣━━ database.yml            # データベース接続設定
  ┣━━ environment.rb          # サーバ起動時の設定
  ┣━━ environments            # 実行環境ごとの設定
  ┃    ┣━━ development.rb     # 開発環境向けの設定
  ┃    ┣━━ production.rb      # 本番環境向けの設定
  ┃    ┗━━ test.rb            # テスト環境向けの設定
  ┣━━ initializers            # 初期化設定
  ┃    ┣━━ application_controller_renderer.rb     # コントローラからビューを呼ぶための設定
  ┃    ┣━━ assets.rb                              # アセットパイプラインの設定
  ┃    ┣━━ backtrace_silencers.rb                 # バックトレースの設定
  ┃    ┣━━ content_security_policy.rb             # Content Security Policy の設定
  ┃    ┣━━ cookies_serializer.rb                  # クッキーのシリアライズの設定
  ┃    ┣━━ filter_paramater_logging.rb            # ログから除外するパラメータの設定
  ┃    ┣━━ inflections.rb                         # 単数形、複数形の変換ルール等の設定
  ┃    ┣━━ mime_types.rb                          # アプリケーションで扱う MIME タイプの設定
  ┃    ┗━━ wrap_parameters.rb                     # パラメータのラップに関する設定
  ┣━━ locales                 #
  ┃    ┗━━ en.yml             # 多言語対応用の辞書ファイル
  ┣━━ master.key              # credentials.yml.enc の復号用キー
  ┣━━ puma.rb                 # Puma用の設定ファイル
  ┣━━ routes.rb               # ルーティングの設定
  ┣━━ spring.rb               # spring(プリローダ)の設定
  ┗━━ strage.yml              # ActiveStrageの設定
```

##### database.yml
- development、test、production、のそれぞれの環境用に、データベースの接続に必要な設定が記述されている。
- YAML で記述されている。
- YAML.load_file('./ファイル名.yml') のコマンドで読み込める。
- 読みこまれたデータは、Ruby ハッシュ形式に変換されている。

```
# YAML の基本
animal:
  cat: 'ネコ'
  dog: 'イヌ'

# エイリアスとアンカー
animal: &animal　  # &エイリアス名　でエイリアス化、共通化できる。
  cat: 'ネコ'
  dog: 'イヌ'

animal_shop_1:
  <<: *animal　    # エイリアスを参照している
  hamster: 'ハムスター'

animal_shop_1:
  <<: *animal　    # 共通で読み込める
  parrot: 'オウム'
```

## Chapter3 タスク管理アプリケーションを作ろう
##### erb 以外のテンプレートエンジン
- Harm や slim がある。

##### レイアウトファイル
- レイアウトファイルはアクションごとに指定できる。個別の指定がなければコントローラ名に対応するものとなる。
- コントローラ名 > 継承コントローラクラス名 > .... > ApplicationControllerと参照していく。最終的に指定がない場合はapplicationのレイアウトが適用される。
- application.html.slim(html.erbも)はデフォルトでapplication.css を読み込む。

### simple_format

## Chapter4 現実の複雑さに対応する

- データベースへの登録、更新が成功すると信じている場合（save前に valid? などでの検証を行わない場合）、save よりも　save! を使った方が予期せぬ失敗を防ぐことができる。

##### モデル検証用ヘルパーメソッド

|検証内容|ヘルパーの使い方の例|
|:---:|:---:|
|必須のデータが入っているか？|validates :foo, **presence:** true|
|数値を期待するところに、数値以外が入っていないか？<br>小数点の有無、正負など期待通りか？|validates :foo, **numericality:** true|
|数値の範囲が期待通りか？|validates :foo, **inclusion:** { in: 0..9 }|
|文字列の長さが想定通りか？|validates :foo, **length:** { maximum: 30 }|
|文字列のフォーマットや構成文字種が想定通りか？|validates :foo, **format:** { with: /\A([^@\s]+)@((?:[-az0-9]+\.)+[a-z]{2,})\z/i }<br>validates :foo, **inclusion:** {in: %w(OK NG)}|
|データが一意になっているか？|validates :foo, **uniqueness:** true|
|パスワードやメールアドレスが、確認用入力と一致しているか？|validates :foo, **confirmation:** true|

### コールバック
- 後から任意のタイミングで実行する処理を予め指定しておく仕組み。

|コールバックのタイミング|メソッド|||
|:---:|:---:|:---:|:---:|
|new / 検索|→|⤵︎||
|↓|after_find<br>after_initialize|↓||
|↓|before_validation|↓|before_destroy<br>around_destroy|
|検証||削除||
|↓|after_validation|↓|after_destroy<br>around_destroy|
|↓|before_create<br>before_save<br>before_update<br>around_create<br>around_save<br>around_update|||
|更新||||
|↓|after_create<br>after_update<br>after_save<br>around_create<br>around_save<br>around_update|||

```
# モデルのコールバック
class Task < ApplicationRecord
  # コールバックを追加
  before_validation :set_nameless_name

  validates :name, presence: true, length: { maximum:30 }

  private
  # コールバックメソッド
  def set_nameless_name
    self.name = '名前なし' if name.blank?
  end
end
```

### トランザクション
- 一連の複数の処理によるデータベースの生合成を保つための機能。
- 例えば送金処理のように、入金と出金がセットになっているような処理で、片方が失敗した場合にロールバックして全て無かったことにできる。
- rails では、コールバック全体を１つのトランザクションで囲ってsaveを実行するので、コールバックの一つで例外が発生するとロールバックが発生し、以降のコールバックは実行されない。

### セッションとCoockie
##### セッション

- Rails では、コントローラから session というメソッドを呼び出すことでセッションにアクセスできる。
- session はハッシュのように扱うことができる。

```
# セッションにデータ格納
session[:user_id] = @user_id

# セッションからデータ取り出し
@user_id = session[:user_id]
```

##### Cookie
- Rails では、cookies というメソッドでブラウザから受け取り送り返す事になる cookie 情報にアクセスしデータを操作できる。
- 基本的にはセッションを使えば済むため、直接cookieを操作する事はあまりない。
- Railsのデフォルトでは、セッションデータはcookieに保管される。故にブラウザで対応するcookieを削除すると、セッションはリセットされる。

### routes

- コントローラアクションのURLを変更

```
# 自動生成されたルーティング
# sessions コントローラーの new アクションの URL は /sessions/new になっている。
get 'sessions/new'

# 下記のように書き換えることで、sessions コントローラーの new アクションのURLは /login になる。
get '/login', to:'sessions#new'
```

##### authenticate メソッド
- 認証のためのメソッド。
- has_secure_password を記述すると自動で authenticate が追加される。
- 引数で受け取ったパスワードをハッシュ化した結果が、Userオブジェクトに保存されている digest と一致するかを調べる。
- 一致すれば認証成功で、そのUserオブジェクトを返す。失敗すればfalseを返す。

```
if authenticate(params[:password])
  session[:user_id] = @user.id
end
```

##### フィルタ
- before_action など、アクションを処理する前に実行する処理。
- skip_before_action :フィルタメソッド　でフィルタをスキップさせることができる。

##### merge メソッド
- ハッシュを結合する。
- コントローラで受け取った params に値を結合するなどに便利かも。

```
def create
  @task = Task.new(task_params.merge(user_id: current_user.id))

# タスクの params に ユーザーid を付加している。
```

### 絞り込み
##### クエリー用メソッド

- クエリー用メソッドはネストすることで重ね掛けすることができる。

|メソッド（絞り込み条件）|効果|
|:---:|:---:|
|where|SQL の where節 を作る。重ね掛けすると AND条件として重なっていく。|
|order|検索結果の並び順を指定する。|
|joins|ほかのテーブルとの JOIN を指定する。|
|group|SQL の GROUP BY 節を作る。|
|select||
|limit||
|distinct||
|all||
|none||

- to_sql メソッドで生成予定の SQL を見ることができる。

```
User.where(admin: true).to_sql
#=> "SELECT \"users\".* FROM \"users\" WHARE \"users\".\"admin\" = 'TRUE'"
```

|メソッド（実行部分）|効果|
|:---:|:---:|
|find||
|find_by||
|なし||
|first||
|last||
|exists?||
|count||
|average||
|maximum||
|minimum||
|update_all||
|delete_all||
|destroy_all||

### scope を活用する
- model の scope は クエリー用のメソッドの連続した処理をまとめて、クエリー用メソッドとして定義できる。

## Chapter5 テストをはじめよう
##### RSpec
- Ruby におけるBDD（振舞駆動開発）のためのテスティングフレームワーク。
- 動く仕様書(Spec)として自動テストを書くという発想で作られている。
- 仕様書という意識が重要なので、その意味を込めて Spec を書くなどと言う。
- Rspec を使う場合、Railsデフォルトの test ディレクトリは不要（削除してよい）。

##### Capybara
- Webアプリケーションの E2E (End-to-End)テスト用フレームワーク。
- Minitest や Rspec と組み合わせて使う。
- Javascriptまでを含めたブラウザ操作をシミュレーションできる。

##### FactoryBot
- テスト用データを作成するgem。

### テストの種類
|分類|テストの種類|Rspecでの呼び方|
|:---:|:---:|:---:|
|全体的なテスト|システムテスト(System Test)<br>E2Eテストに相当。ブラウザを通してアプリの挙動を外部的に確認できる。|System Spec<br>Feature Spec|
||結合テスト(Integration Test)<br>いろいろな機能の連携が想定通りに動くかを確認するテスト。|Request Spec|
||機能テスト(Function Test)<br>コントローラ単位のテスト<br>※ 現在は推奨されておらず、結合テスト相当のRequest Specを使うことが推奨されている。|Controller Spec|
|個々部品のテスト|モデル|Model Spec|
||ルーティング|Routing Spec|
||ビュー|View Spec|
||ヘルパー|Helper Spec|
||メーラー|Mailer Spec|
||ジョブ<br>※ 非同期処理の処理のかたまりをジョブと呼ぶ。|Job Spec|

- システムテスト(Feature Spec)が最も重要。

##### System Spec とは
- Feature Spec に代わって System Spec を利用するメリット。
- テスト終了時にDBが自動でロールバックされるので、database_creanerなどのgemが不要。
- テスト失敗時にスクリーンショットを撮影しターミナルに表示してくれる。
- driven_by を使って specごとにブラウザを簡単に切り替えられる。

##### Spec の書き方

```
describe テスト対象, type: Specの種類 do

  context ある状態 do
    before do
      事前準備
    end

    it 仕様の内容 do
      期待する動作
    end
  end

end
```

### FactoryBot でテストデータを作成する
- データを作成するためのテンプレートファイルを「ファクトリ」という。

```
FactoryBot.define do
  # :user というファクトリ名で User クラスを類推してくれる。
  factory :user do
    name {'テストユーザー'}
    email {'test1@example.com'}
    password {'password'}
  end
end
```
```
FactoryBot.define do
  # ファクトリ名とクラスが異なる場合、:class オプションでクラスを指定できる。
  factory :admin_user do, class: User do
    name {'管理ユーザー'}
    email {'admin1@example.com'}
    password {'password'}
  end
end
```
```
# user の記述で :user （ファクトリ）とアソシエーションを生成する。
# モデル名とファクトリ名が異なる場合は下記のように指定する。
# association :user, factory: :admin_user

FactoryBot.define do
  factory :task do
    name {'テストを書く'}
    description {'RSpec & Capybara & FactoryBot を準備する'}
    user
  end
end
```

- rspec の実行

```
$ bundle exec rspec ファイルパス

$ bundle exec rspec spec/system/task_spec.rb
```
##### shared_examples で it を共通化する
- it などの挙動を期待する　example をまとめて名前をつけ、テストケース間で共通化できる。

```
shared_examples_for 'ユーザーAが作成したタスクが表示される' do
  it { expect(page).to have_content 'ユーザーAのタスク'}
end
.
.
.
describe '一覧表示機能' do
  context 'ユーザーAがログインしているとき' do
    let(:login_user) { user_a }

    # it_behaves_like で呼び出す。
    it_behaves_like 'ユーザーAが作成したタスクが表示される'
  end
```
